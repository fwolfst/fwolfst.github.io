<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Installing mailtrain with dokku</title>
  <meta name="description" content="Aim">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="/devops/dokku/2021/03/07/mailtrain_dokku.html">
  <link rel="alternate" type="application/rss+xml" title="felix wolfsteller - blog" href="/feed.xml" />
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">felix wolfsteller - blog</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
        
          
          <a class="page-link" href="/about/">About these pages</a>
          
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
          <a class="page-link" href="/categories/">Categories</a>
          
        
          
        
          
        
          
        
          
        
          
          <a class="page-link" href="/resources/">Resources</a>
          
        
          
        
          
        
          
          <a class="page-link" href="/tag/docker/">:: docker</a>
          
        
          
          <a class="page-link" href="/tag/dokku/">:: dokku</a>
          
        
          
          <a class="page-link" href="/tag/virtualization/">:: virtualization</a>
          
        
          
          <a class="page-link" href="/tag/bash/">:: bash</a>
          
        
          
          <a class="page-link" href="/tag/pfsense/">:: pfsense</a>
          
        
          
          <a class="page-link" href="/tag/intranet/">:: intranet</a>
          
        
          
          <a class="page-link" href="/tag/solidus/">:: solidus</a>
          
        
          
          <a class="page-link" href="/tag/online-shop/">:: online-shop</a>
          
        
          
          <a class="page-link" href="/tag/rails/">:: rails</a>
          
        
          
          <a class="page-link" href="/tag/css/">:: css</a>
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Installing mailtrain with dokku</h1>
    <p class="post-meta">
    Mar 7, 2021
    <span>[
      
    ]</span>
    </p>
  </header>

  <article class="post-content">
    <h2 id="aim">Aim</h2>

<ul>
  <li>install <a href="https://mailtrain.org">mailtrain</a> on a <a href="https://dokku.com">dokku</a></li>
</ul>

<h3 id="requirements">Requirements</h3>

<ul>
  <li>reasonably fresh dokku host</li>
</ul>

<h2 id="why">Why</h2>

<p>Although an old craft, sending and receiving e-mail is not necessarily an easy
task. Many different clients shall render the result nicely and sending itself
needs some special care to not end up in spam folders.</p>

<p>There are multiple open source solutions to tackle the design/layout and
receipients management problems. One of them is
<a href="https://mailtrain.org">mailtrain</a> which includes some relatively slick editor
tools (mosaico and grapejs) that allow users to achieve good results without
understanding much of HTML and CSS. The state of the solution itself is pretty
old, with a version 2 in beta since ever.</p>

<p>As <a href="https://dokku.com">dokku</a> is a cool deployment solution, Iâ€™ll outline the
process to install mailtrain on a dokku host here.</p>

<h3 id="prepare-the-deployable-code">Prepare the deployable code</h3>

<h4 id="checkout-the-mailtrain-code">Checkout the mailtrain code</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/Mailtrain-org/mailtrain
<span class="nb">cd </span>mailtrain
</code></pre></div></div>

<h4 id="prepare-the-configuration-file">Prepare the configuration file</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cp </span>config/default.toml config/production.toml
git add <span class="nt">-f</span> config/production.toml <span class="c"># attention, this file should never see the</span>
                                  <span class="c"># public!</span>
git commit <span class="nt">-m</span> <span class="s2">"cp config/default.toml config/production.toml"</span>

<span class="c"># Adjust basic values if you want</span>
vim config/production.toml
git add config/production.toml
git commit <span class="nt">-m</span> <span class="s2">"basic configuration"</span>
</code></pre></div></div>

<h3 id="prepare-the-dokku-host">Prepare the dokku host</h3>

<h4 id="create-skeleton-app">Create skeleton app</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dokku apps:create mailtrain
</code></pre></div></div>

<h4 id="mysql">MySQL</h4>

<h5 id="plugin-installation">Plugin installation</h5>

<p>If you have not yet installed the dokku plugin, do so</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dokku plugin:install https://github.com/dokku/dokku-mysql.git mysql
</code></pre></div></div>

<h5 id="create-and-link-a-database">Create and link a database</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dokku mysql:create mailtrain
dokku mysql:link mailtrain mailtrain
</code></pre></div></div>

<h4 id="redis">Redis</h4>

<h5 id="plugin-installation-1">Plugin installation</h5>

<p>If you have not yet installed the dokku plugin, do so</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dokku plugin:install https://github.com/dokku/dokku-redis.git redis
</code></pre></div></div>

<h5 id="create-and-link-the-redis-database">Create and link the redis database</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dokku redis:create mailtrain
dokku redis:link mailtrain mailtrain
</code></pre></div></div>

<h3 id="adjust-the-mailtrain-configuration">Adjust the mailtrain configuration</h3>

<p>Both the <code class="language-plaintext highlighter-rouge">redis:create/link</code> and the <code class="language-plaintext highlighter-rouge">mysql:create/link</code> commands executed
earlier create output containing host, name and credentials for the service.</p>

<p>If you cannot access the output anymore, <code class="language-plaintext highlighter-rouge">dokku redis:info mailtrain</code> (and
<code class="language-plaintext highlighter-rouge">dokku mysql:info mailtrain</code>) will provide it again (look for the <code class="language-plaintext highlighter-rouge">dsn</code> line).</p>

<p>Edit the mailtrain configuration accordingly:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vim config/production.toml
<span class="c"># [mysql] host,user,password,database</span>
<span class="c"># [redis] host,password(uncomment)</span>
git add
git commit <span class="nt">-m</span> <span class="s2">"configure dokku redis and mysql databases"</span>
</code></pre></div></div>

<h3 id="add-volumes">Add volumes</h3>

<p>Create folders on host to mount in guest.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir</span> <span class="nt">-p</span> /var/lib/dokku/data/storage/mailtrain/grapejs_uploads/
<span class="nb">mkdir</span> <span class="nt">-p</span> /var/lib/dokku/data/storage/mailtrain/mosaico_uploads/
<span class="nb">mkdir</span> <span class="nt">-p</span> /var/lib/dokku/data/storage/mailtrain/reports/
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dokku storage:mount mailtrain /var/lib/dokku/data/storage/mailtrain/reports:/app/protected/reports
dokku storage:mount mailtrain /var/lib/dokku/data/storage/mailtrain/grapejs_uploads:/app/public/grapejs/uploads
dokku storage:mount mailtrain /var/lib/dokku/data/storage/mailtrain/mosaico_uploads:/app/public/mosaico/uploads

<span class="c"># docker deploy needs containers permissions</span>
<span class="nb">chown</span> <span class="nt">-R</span> dokku:dokku /var/lib/dokku/data/storage/mailtrain/
</code></pre></div></div>

<h3 id="deploy">Deploy</h3>

<p>Now it is time to push your mailtrain instance for deployment:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># in mailtrain source</span>
git remote add online dokku@yourdokkuhost:mailtrain
git push online master
</code></pre></div></div>

<h4 id="add-a-domain">Add a domain</h4>

<p>If you want an additional domain, add it</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dokku domains:add mailtrain newsletter.mydokku.host
</code></pre></div></div>

<h4 id="letsencrypt-it">letsencrypt it</h4>

<p>The letsencrypt plugin needs <a href="https://github.com/dokku/dokku-letsencrypt#dockerfile-deploys">special treatment</a> for Dockerfile deploys.</p>

<p>Following the readme, we map the ports for certificate fetching</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># install, if you have not yet:</span>
<span class="c"># dokku plugin:install https://github.com/dokku/dokku-letsencrypt.git</span>

dokku proxy:ports-add mailtrain http:80:5555
dokku lentsencrypt mailtrain
dokku proxy:ports-add mailtrain https:443:3000
dokku proxy:ports-remove mailtrain http:5555:5555
</code></pre></div></div>
<!--
Port mappings for mailtrain
scheme             host port                 container port                                     
http                      3000                      3000                                               
http                      80                        5555                                               
https                     3000                      3000                                               
https                     443                       3000                                               
https                     443                       5555 
-->

<h2 id="enjoy">Enjoy!</h2>

<p>Your mailtrain instance should be up and running. Follow the <a href="https://github.com/Mailtrain-org/mailtrain">documentation</a> to
configure it. The language can be changed in the <code class="language-plaintext highlighter-rouge">config/production.toml</code> file
only and the language code has to match the files in <code class="language-plaintext highlighter-rouge">languages</code>. Commit and
push to update the configuration.</p>

<h2 id="final-thoughts">Final Thoughts</h2>

<p>dokku will attempt a deployment based on the <code class="language-plaintext highlighter-rouge">Dockerfile</code> in the code
repository. This is fine, although the idea of even more standardized buildpacks
charms me more and leads to less hazzle (e.g. with letsencrypt setup).
However, I couldnt get the default buildpacks run mailtrain nicely. I would
blame the still very busy nodejs ecosystem (grunt, nodeversion, blabla).</p>

<p>Putting sensitive configuration in a git repository is not the optimal solution
here, but allowed us to fire up the application quickly.</p>

<p>It would be great if mailtrain supported setting the database urls via
a single environment variable (it does allow environment callbacks in its
configuration file, though - so feel free to do that, via <code class="language-plaintext highlighter-rouge">dokku config:set</code>).</p>

<p>Heroku, dokku and at least Ruby on Rails set and read <code class="language-plaintext highlighter-rouge">DATABASE_URL</code>, which
would make the manual database configuration obsolete. I <a href="https://github.com/Mailtrain-org/mailtrain/issues/1020">filed an issue</a> on
mailtrain, but the project is most likely busy with v2; but anyone js should be
able to craft a PR pretty quickly.</p>

<h4 id="having-a-better-idea">Having a better idea?</h4>

<p>Awesome!  Get in contact with me!</p>

  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">felix wolfsteller - blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>felix wolfsteller - blog</li>
          <li><a href="mailto:your-email@example.com">your-email@example.com</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/fwolfst">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">fwolfst</span>
            </a>
          </li>
          

          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">Mostly technical blog of Felix Wolfsteller (econya)</p>
        <p class="text">Available and happy to rock a gig for you.</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
